<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äººå·¥å®¡æ ¸åå°</title>
    <style>
        * {margin: 10px;padding: 0;box-sizing: border-box;}
        .container {width: 1200px;margin: 0 auto;}
        .feedback-item {border: 1px solid #ccc;padding: 15px;margin: 10px 0;border-radius: 8px;background: #f9f9f9;}
        .pending {color: orange;font-weight: bold;font-size:16px;}
        .completed {color: green;font-weight: bold;font-size:16px;}
        button {padding: 8px 20px;margin-right:10px;border: none;border-radius:4px;cursor: pointer;}
        .view-btn {background: #3498db;color:white;}
        .audit-btn {background: #27ae60;color:white;}
        .img-btn {background: #9b59b6;color:white; margin-top:5px;} /* æ–°å¢ï¼šå›¾ç‰‡æŒ‰é’®ç´«è‰²åŒºåˆ† */
        .feedback-item p {line-height:1.6;margin:8px 0;}
        h2 {text-align:center;color:#e74c3c;margin-bottom:20px;}
        /* è§†é¢‘å¼¹çª—æ ·å¼ ä¸å˜ */
        #videoModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            padding: 20px;
        }
        #videoModal .modal-content {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        #modalVideoPlayer {
            width: 100%;
            max-height: 400px;
            margin: 20px 0;
        }
        /* æ–°å¢ï¼šå›¾ç‰‡é¢„è§ˆå¼¹çª—æ ·å¼ï¼ˆå’Œè§†é¢‘å¼¹çª—åŒé£æ ¼ï¼‰ */
        #imgModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            padding: 20px;
        }
        #imgModal .modal-content {
            max-width: 900px;
            margin: 50px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        #modalImg {
            max-width: 100%;
            max-height: 70vh;
            margin: 20px 0;
            border-radius: 4px;
        }
        .loading-text {color: #666;font-style: italic;}
        .error-text {color: #e74c3c;}
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ” è§†é¢‘å®¡æ ¸åé¦ˆå¤„ç†åå°</h2>
        <div id="feedbackList">åŠ è½½ä¸­...</div>
    </div>

    <!-- è§†é¢‘é¢„è§ˆå¼¹çª— (åŸæœ‰ æ— ä¿®æ”¹) -->
    <div id="videoModal">
        <div class="modal-content">
            <h3 style="text-align: center; color: #e74c3c;">åŸè§†é¢‘é¢„è§ˆ</h3>
            <video id="modalVideoPlayer" controls controlsList="nodownload">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ï¼Œè¯·ä½¿ç”¨Chrome/Firefox/Edge
            </video>
            <div style="margin: 20px 0; line-height: 1.8;">
                <p><strong>è§†é¢‘åˆ†è¾¨ç‡:</strong> <span id="modalVideoResolution" class="loading-text">åŠ è½½ä¸­...</span></p>
                <p><strong>è§†é¢‘æ—¶é•¿:</strong> <span id="modalVideoDuration" class="loading-text">åŠ è½½ä¸­...</span></p>
            </div>
            <button onclick="closeVideo()" style="background: #e74c3c; color: white; padding: 8px 20px; border-radius: 4px;">
                å…³é—­é¢„è§ˆ
            </button>
        </div>
    </div>

    <!-- æ–°å¢ï¼šå›¾ç‰‡è¯æ®é¢„è§ˆå¼¹çª— -->
    <div id="imgModal">
        <div class="modal-content">
            <h3 style="text-align: center; color: #9b59b6;">åé¦ˆè¯æ®å›¾ç‰‡</h3>
            <img id="modalImg" alt="åé¦ˆè¯æ®å›¾ç‰‡">
            <button onclick="closeImgModal()" style="background: #e74c3c; color: white; padding: 8px 20px; border-radius: 4px;">
                å…³é—­å›¾ç‰‡
            </button>
        </div>
    </div>

    <script>
        // 1. åŠ è½½åé¦ˆåˆ—è¡¨ã€æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ å›¾ç‰‡è¯æ®æŒ‰é’®æ¸²æŸ“ã€‘
        async function loadFeedbacks() {
            const feedbackList = document.getElementById("feedbackList");
            try {
                const res = await fetch('/get-feedback-list');
                const result = await res.json();
                if (result.success && result.feedbacks.length > 0) {
                    feedbackList.innerHTML = "";
                    result.feedbacks.forEach(feedback => {
                        // åˆ¤æ–­å½“å‰åé¦ˆæ˜¯å¦æœ‰ä¸Šä¼ å›¾ç‰‡è¯æ®
                        const hasImg = feedback.feedback_img && feedback.feedback_img.trim() !== "";
                        feedbackList.innerHTML += `
                            <div class="feedback-item">
                                <p><strong>åé¦ˆID:</strong> ${feedback.feedback_id}</p>
                                <p><strong>è§†é¢‘ID:</strong> ${feedback.video_id}</p>
                                ${feedback.frame_index ? `<p><strong>å¸§ç´¢å¼•:</strong> ${feedback.frame_index}</p>` : ""}
                                <p><strong>åé¦ˆç±»å‹:</strong> ${feedback.feedback_type === "frame" ? "å¸§è§£è¯»åé¦ˆ" : "æ•´ä½“é£é™©è¯„ä¼°åé¦ˆ"}</p>
                                <p><strong>åé¦ˆç†ç”±:</strong> ${feedback.feedback_reason}</p>
                                <p><strong>è¯¦ç»†è¯´æ˜:</strong> ${feedback.feedback_desc}</p>
                                <p><strong>åé¦ˆæ—¶é—´:</strong> ${feedback.feedback_time}</p>
                                <p><strong>å®¡æ ¸çŠ¶æ€:</strong> <span class="${feedback.status}">${feedback.status === "pending" ? "âœ… å¾…å®¡æ ¸" : "âœ… å·²å®Œæˆ"}</span></p>
                                <button class="view-btn" onclick="viewVideo('${feedback.video_id}')">æŸ¥çœ‹åŸè§†é¢‘</button>
                                <button class="audit-btn" onclick="openAuditForm('${feedback.feedback_id}')">å¤„ç†è¯¥åé¦ˆ</button>
                                <!-- æ ¸å¿ƒæ–°å¢ï¼šæœ‰å›¾ç‰‡å°±æ˜¾ç¤ºã€æŸ¥çœ‹è¯æ®å›¾ç‰‡ã€‘æŒ‰é’® -->
                                ${hasImg ? `<button class="img-btn" onclick="viewFeedbackImg('${feedback.feedback_img}')">æŸ¥çœ‹è¯æ®å›¾ç‰‡</button>` : ''}
                            </div>
                        `;
                    });
                } else {
                    feedbackList.innerHTML = "<p style='text-align:center;font-size:16px;'>æš‚æ— å¾…å¤„ç†çš„åé¦ˆæ•°æ®</p>";
                }
            } catch (err) {
                feedbackList.innerHTML = `<p style='color:red;text-align:center;'>åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
            }
        }

        // 2. æŸ¥çœ‹è§†é¢‘ï¼ˆåŸæœ‰ æ— ä¿®æ”¹ï¼Œå·²ä¿®å¤å¤šæ¬¡é¢„è§ˆé—®é¢˜ï¼‰
        async function viewVideo(videoId) {
            const modal = document.getElementById('videoModal');
            const videoPlayer = document.getElementById('modalVideoPlayer');
            const resElem = document.getElementById('modalVideoResolution');
            const durElem = document.getElementById('modalVideoDuration');

            resElem.textContent = "åŠ è½½ä¸­...";
            durElem.textContent = "åŠ è½½ä¸­...";
            modal.style.display = 'block';

            try {
                const res = await fetch(`/get-video-info?video_id=${videoId}`);
                const { success, video_info } = await res.json();
                if (!success) {
                    alert(`è§†é¢‘ä¸å­˜åœ¨ï¼š${video_info?.message || 'æœªçŸ¥é”™è¯¯'}`);
                    closeVideo();
                    return;
                }
                videoPlayer.src = video_info.url;
                videoPlayer.onloadedmetadata = () => {
                    resElem.textContent = `${videoPlayer.videoWidth}Ã—${videoPlayer.videoHeight}`;
                    durElem.textContent = `${(videoPlayer.duration/60).toFixed(2)}åˆ†é’Ÿ`;
                    videoPlayer.play();
                };
            } catch (err) {
                alert(`åŠ è½½å¤±è´¥ï¼š${err.message}`);
                closeVideo();
            }
        }

        // 3. å…³é—­è§†é¢‘ï¼ˆåŸæœ‰ æ— ä¿®æ”¹ï¼Œå½»åº•é‡Šæ”¾èµ„æºï¼‰
        function closeVideo() {
            const videoPlayer = document.getElementById('modalVideoPlayer');
            videoPlayer.pause();
            videoPlayer.src = "";
            videoPlayer.removeAttribute('src');
            videoPlayer.load();
            document.getElementById('videoModal').style.display = 'none';
        }

        // ========== æ ¸å¿ƒæ–°å¢ï¼š4. æŸ¥çœ‹åé¦ˆçš„è¯æ®å›¾ç‰‡ ==========
        function viewFeedbackImg(imgBase64) {
            const imgModal = document.getElementById('imgModal');
            const modalImg = document.getElementById('modalImg');
            // Base64ç›´æ¥èµ‹å€¼ç»™imgæ ‡ç­¾å³å¯æ˜¾ç¤º
            modalImg.src = imgBase64;
            imgModal.style.display = 'block';
        }

        // ========== æ ¸å¿ƒæ–°å¢ï¼š5. å…³é—­å›¾ç‰‡å¼¹çª—ï¼Œé‡Šæ”¾å›¾ç‰‡èµ„æº ==========
        function closeImgModal() {
            const imgModal = document.getElementById('imgModal');
            const modalImg = document.getElementById('modalImg');
            // æ¸…ç©ºå›¾ç‰‡srcï¼Œé‡Šæ”¾å†…å­˜
            modalImg.src = "";
            imgModal.style.display = 'none';
        }

        // 6. å¤„ç†å®¡æ ¸ï¼ˆåŸæœ‰ æ— ä¿®æ”¹ï¼‰
        async function openAuditForm(feedbackId) {
            try {
                const res = await fetch(`/get-feedback?feedback_id=${feedbackId}`);
                const { success, feedback } = await res.json();
                if (!success) {
                    alert("è·å–åé¦ˆå¤±è´¥ï¼š" + feedback?.message);
                    return;
                }
                const level = prompt("é£é™©ç­‰çº§ï¼ˆé«˜/ä¸­/ä½ï¼‰:", "ä¸­");
                if(!['é«˜','ä¸­','ä½'].includes(level)){
                    alert("åªèƒ½è¾“å…¥é«˜/ä¸­/ä½");
                    return;
                }
                const desc = prompt("å®¡æ ¸è¯´æ˜:", feedback.risk_desc || "");
                if (!level || !desc) return;

                const submitRes = await fetch('/submit-re-audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        feedback_id: feedbackId,
                        re_audit_data: { status: "completed", re_audit_level: level, re_audit_desc: desc, re_audit_time: new Date().toLocaleString() }
                    })
                });
                const submitResult = await submitRes.json();
                if (submitResult.success) {
                    alert("å®¡æ ¸æäº¤æˆåŠŸï¼");
                    loadFeedbacks();
                } else {
                    alert("æäº¤å¤±è´¥ï¼š" + submitResult.message);
                }
            } catch (err) {
                alert("å¤„ç†å¤±è´¥ï¼š" + err.message);
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = () => {
            loadFeedbacks();
            setInterval(loadFeedbacks, 5000);
        };
    </script>
</body>
</html>