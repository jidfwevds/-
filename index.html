<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIGCè§†é¢‘å®¡æ ¸ç³»ç»Ÿ</title>

    <!-- å¼•å…¥CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="static/css/style.css">
    <script src="static/js/chart.js-4.5.1/chart.umd.min.js"></script>
    <!-- æ·»åŠ è°ƒè¯•æ ·å¼ -->
    <style>
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
        }
        .frame-desc-bubble {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px;
            width: 320px;
            z-index: 10;
        }
        .bubble-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .bubble-title {
            font-weight: bold;
            color: #333;
        }
        .bubble-close {
            background: transparent;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0 5px;
        }
        .bubble-close:hover {
            color: #e74c3c;
        }
        .small-spinner {
            width: 20px;
            height: 20px;
            border-width: 2px;
            margin: 0 auto;
        }
        .loading-spinner {
            border: 4px solid rgba(97, 189, 249, 0.2);
            border-top: 4px solid #61bdf9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¬ AIGCè§†é¢‘å†…å®¹å®‰å…¨å®¡æ ¸ç³»ç»Ÿ</h1>

        <!-- 1. è§†é¢‘ä¸Šä¼ åŒºåŸŸ -->
       <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
    <div class="upload-area">
        <h3>é€‰æ‹©è§†é¢‘æ¥æº</h3>
        <div style="margin-bottom: 20px; display: flex; justify-content: center; gap: 30px; font-size: 16px;">
            <label class="radio-label">
                <input type="radio" name="videoSource" value="local" checked onclick="toggleVideoSource(this)">
                <span>æœ¬åœ°è§†é¢‘æ–‡ä»¶</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="videoSource" value="url" onclick="toggleVideoSource(this)">
                <span>ç½‘é¡µè§†é¢‘URL</span>
            </label>
        </div>

        <div class="file-input-wrapper" id="localFileArea">
            <input type="file" name="video" id="videoFileInput" accept=".mp4,.avi,.mov,.mkv,.webm">
            <label for="videoFileInput" class="file-input-label">
                é€‰æ‹©è§†é¢‘æ–‡ä»¶
            </label>
        </div>

        <div id="videoUrlArea" style="display: none; margin: 20px 0;">
            <input type="text" id="videoUrlInput" placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘URLï¼ˆæ”¯æŒMP4/AVI/MOV/MKV/WebMï¼‰"
                   style="width: 80%; padding: 12px 16px; border: 2px solid #61bdf9; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.3s ease;">
            <p style="margin-top: 8px; font-size: 12px; color: #7f8c8d;">æ”¯æŒç›´é“¾è§†é¢‘URLï¼Œç¤ºä¾‹ï¼šhttps://xxx.com/test.mp4</p>
        </div>

        <div class="file-info" id="fileInfo">
            æ”¯æŒæ ¼å¼: MP4, AVI, MOV, MKV, WebM | æœ€å¤§å¤§å°: 500MB
        </div>
        <div style="margin-top: 20px;">
            <button type="submit" class="btn" id="uploadBtn" disabled>
                <span>â¬† ä¸Šä¼ /è·å–è§†é¢‘</span>
            </button>
        </div>
        <div id="localPreviewInfo" style="margin-top: 15px; display: none;">
            <p style="color: #27ae60; font-size: 14px;">è§†é¢‘å·²é€‰æ‹©ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ </p>
        </div>
    </div>
</form>

        <!-- 2. è§†é¢‘é¢„è§ˆåŒº -->
        <div class="video-container" id="videoPreviewArea">
            <h3>ğŸ“‹ å¾…æ£€æµ‹è§†é¢‘é¢„è§ˆ</h3>
            <video class="video-player" controls controlsList="nodownload" id="previewVideoPlayer">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeç­‰ç°ä»£æµè§ˆå™¨
            </video>
            <div class="video-info">
                <img id="videoThumbnail" class="video-thumbnail" src="" alt="è§†é¢‘ç¼©ç•¥å›¾">
                <div class="video-stats">
                    <p><strong>è§†é¢‘åç§°:</strong> <span id="videoFileName">æœªé€‰æ‹©</span></p>
                    <p><strong>è§†é¢‘å¤§å°:</strong> <span id="videoFileSize">0 MB</span></p>
                    <p><strong>è§†é¢‘æ—¶é•¿:</strong> <span id="videoDuration">0:00</span></p>
                    <p><strong>è§†é¢‘å°ºå¯¸:</strong> <span id="videoDimensions">0Ã—0</span></p>
                </div>
            </div>
            <p class="video-tip">âœ… è§†é¢‘åŠ è½½å®Œæˆï¼Œæ”¯æŒæ’­æ”¾/æš‚åœ/è¿›åº¦æ¡/éŸ³é‡æ§åˆ¶</p>
            <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
                <button id="startAnalysisBtn" class="btn btn-analysis" disabled>
                    <span>ğŸš€ å¼€å§‹è§†é¢‘å†…å®¹åˆ†æ</span>
                    <span class="status-indicator" id="analysisStatus" style="display: none;"></span>
                </button>
                <button id="resetBtn" class="btn"
                    style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <span>ğŸ”„ é‡æ–°é€‰æ‹©è§†é¢‘</span>
                </button>
            </div>
        </div>

        <!-- 3. è¿›åº¦æ¡åŒºåŸŸ -->
        <div class="progress-section" id="progressArea">
            <div class="progress-title" id="progressTitle">
                <span>å‡†å¤‡å¼€å§‹...</span>
                <span class="status-indicator status-analyzing" id="progressStatus">åˆ†æä¸­</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">
                <span>å½“å‰è¿›åº¦ï¼š0%</span>
                <span style="margin-left: 20px;" id="performanceInfo"></span>
            </div>
        </div>

        <!-- åœæ­¢åˆ†ææŒ‰é’®å®¹å™¨ -->
        <div class="stop-analysis-container" id="stopAnalysisContainer">
            <button id="stopAnalysisBtn" class="btn"
                style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <span>â¹ï¸ åœæ­¢åˆ†æ</span>
            </button>
        </div>

        <!-- 4. å¸§é¢„è§ˆæ’­æ”¾åŒº -->
        <div class="frame-section" id="framePreviewArea">
            <h3 class="frame-title">ğŸï¸ æŠ½å–å¸§é¢„è§ˆï¼ˆè¿è§„å¸§æ ‡è®°ä¸ºçº¢è‰²ï¼‰</h3>

            <div class="frame-player">
                <button class="frame-btn" id="prevFrameBtn" title="ä¸Šä¸€å¸§" disabled>â—€</button>
                <div class="frame-display">
                    <img id="currentFrameImg" class="frame-img" src="" alt="å½“å‰å¸§">
                    <div class="frame-tag tag-safe" id="frameTag">å®‰å…¨å¸§</div>
                </div>
                <button class="frame-btn" id="nextFrameBtn" title="ä¸‹ä¸€å¸§" disabled>â–¶</button>
                <button class="frame-btn" id="playFrameBtn" title="æ’­æ”¾/æš‚åœ" disabled>â–¶ï¸</button>
            </div>

            <div class="frame-list" id="frameList">
                <div style="text-align: center; width: 100%; padding: 40px; color: #7f8c8d;">
                    åˆ†æå®Œæˆåï¼Œå¸§åˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
                </div>
            </div>

            <div class="frame-stats">
                <div class="stat-item">
                    <span class="stat-label">å¸§ç¼–å·ï¼š</span>
                    <span class="stat-value" id="frameIndex">0/0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ææ€–é£é™©ï¼š</span>
                    <span class="stat-value" id="frameHorror">0.00%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æš´åŠ›é£é™©ï¼š</span>
                    <span class="stat-value" id="frameViolence">0.00%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">è‰²æƒ…é£é™©ï¼š</span>
                    <span class="stat-value" id="frameNsfw">0.000%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å¸§åˆ¤å®šï¼š</span>
                    <span class="stat-value stat-safe" id="frameIsRisk">å®‰å…¨</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ¨ç†è€—æ—¶ï¼š</span>
                    <span class="stat-value" id="frameSingleDuration">0.0000 ç§’</span>
                </div>
            </div>
        </div>

        <!-- 5. ç»“æœæ±‡æ€»åŒº -->
        <div class="result-section" id="resultArea">
            <div class="result-card">
                <h3 style="color: #27ae60; text-align: center; margin-bottom: 30px;">âœ… åˆ†æå®Œæˆ</h3>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>ğŸ“Š æ€»ä½“è¯„ä¼°</h4>
                        <p><strong>é£é™©ç­‰çº§:</strong> <span id="totalRiskLevel"
                                style="font-size: 1.2em; font-weight: bold;">ä½é£é™©</span></p>
                        <p><strong>é£é™©åˆ†æ•°:</strong> <span id="totalRiskScore">0.0</span>/10</p>
                        <p><strong>è¯´æ˜:</strong> <span id="totalRiskDesc">æ— é£é™©</span></p>
                        <div style="margin-top:15px;">
                           <button class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="goToFeedbackForVideo()">
                            <span>æˆ‘è¦åé¦ˆ</span>
                           </button>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸ” è§†é¢‘ä¿¡æ¯</h4>
                        <p><strong>åˆ†è¾¨ç‡:</strong> <span id="videoResolution">0Ã—0</span></p>
                        <p><strong>æ—¶é•¿:</strong> <span id="videoResultDuration">0.00</span>ç§’</p>
                        <p><strong>å¸§ç‡:</strong> <span id="videoFps">0.00</span></p>
                    </div>
                </div>
                <!-- ========== æ–°å¢ï¼šäººå·¥å®¡æ ¸ç»“æœå±•ç¤ºåŒº ========== -->
<!-- ========== æ–°å¢ï¼šäººå·¥å®¡æ ¸ç»“æœå±•ç¤ºåŒºï¼ˆå¸¦åˆ·æ–°æŒ‰é’®ï¼‰ ========== -->
<div class="stats-grid">
    <div class="stat-card">
        <h4>ğŸ‘¤ äººå·¥å®¡æ ¸ç»“æœ</h4>
        <p><strong>å®¡æ ¸é£é™©ç­‰çº§:</strong> <span id="reAuditLevel" style="font-size: 1.2em; font-weight: bold;">æš‚æ— </span></p>
        <p><strong>å®¡æ ¸è¯´æ˜:</strong> <span id="reAuditDesc">æš‚æ— äººå·¥å®¡æ ¸</span></p>
        <p><strong>å®¡æ ¸æ—¶é—´:</strong> <span id="reAuditTime">æš‚æ— </span></p>
        <!-- æ–°å¢ï¼šæ‰‹åŠ¨åˆ·æ–°æŒ‰é’® -->
        <button id="refreshReAuditBtn" class="btn" style="margin-top:10px; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
            ğŸ”„ åˆ·æ–°äººå·¥å®¡æ ¸ç»“æœ
        </button>
    </div>
</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>ğŸ“ˆ åˆ†æç»Ÿè®¡</h4>
                        <p><strong>æ€»å¸§æ•°:</strong> <span id="totalFrames">0</span></p>
                        <p><strong>åˆ†æå¸§æ•°:</strong> <span id="analyzedFrames">0</span></p>
                        <p><strong>é£é™©å¸§æ•°:</strong> <span id="riskFrames">0</span></p>
                        <p><strong>é£é™©æ¯”ä¾‹:</strong> <span id="riskRatio">0.00%</span></p>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸš« é£é™©åˆ†æï¼ˆä¸‰æ¨¡å‹ï¼‰</h4>
                        <p><strong>å¹³å‡ææ€–é£é™©:</strong> <span id="avgHorror">0.00</span></p>
                        <p><strong>å¹³å‡æš´åŠ›é£é™©:</strong> <span id="avgViolence">0.00</span></p>
                        <p><strong>å¹³å‡è‰²æƒ…é£é™©:</strong> <span id="avgNsfw">0.000</span></p>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>â±ï¸ æ€§èƒ½ç»Ÿè®¡</h4>
                        <p><strong>æ€»è€—æ—¶:</strong> <span id="totalDuration">0.00</span>ç§’</p>
                        <p><strong>æ¨ç†è€—æ—¶:</strong> <span id="inferDuration">0.00</span>ç§’</p>
                        <p><strong>æ‰¹æ¬¡æ•°é‡:</strong> <span id="batchCount">0</span></p>
                        <p><strong>å¹³å‡æ¨ç†æ—¶é—´:</strong> <span id="avgInferTime">0.00</span>ms/å¸§</p>
                    </div>
                    <div class="stat-card">
                        <h4>âš¡ é€Ÿåº¦ç»Ÿè®¡</h4>
                        <p><strong>æ¨ç†FPS:</strong> <span id="inferenceFps">0.00</span> å¸§/ç§’</p>
                        <p><strong>æ•´ä½“FPS:</strong> <span id="overallFps">0.00</span> å¸§/ç§’</p>
                        <p><strong>æ‰¹æ¬¡æ•ˆç‡:</strong> <span id="batchEfficiency">0.0</span>%</p>
                        <p><strong>è®¾å¤‡:</strong> <span id="deviceInfo">CPU</span></p>
                    </div>
                </div>

                <div class="full-video-section" id="fullVideoSection">
                    <h3 class="full-video-title">å®Œæ•´è§†é¢‘æŸ¥çœ‹</h3>
                    <div id="fullVideoLoading" class="video-loading">
                        <div class="loading-spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                        <p style="margin-top: 10px;">æ­£åœ¨åŠ è½½å®Œæ•´è§†é¢‘...</p>
                    </div>
                    <div style="position: relative;">
                        <video class="video-player" controls controlsList="nodownload" id="fullVideoPlayer">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeç­‰ç°ä»£æµè§ˆå™¨
                        </video>
                        <div id="frameDescBubble" class="frame-desc-bubble" style="display: none;">
                           <div class="bubble-header">
                               <span class="bubble-title">å¸§å†…å®¹è§£è¯»</span>
                               <button class="bubble-close" id="bubbleCloseBtn">Ã—</button>
                            </div>
                            <div class="bubble-content" id="bubbleContent">
                               <div class="loading-spinner small-spinner"></div>
                                <p>æ­£åœ¨è§£æå¸§å†…å®¹...</p>
                              </div>
                        </div>
                    </div>
                    <p class="video-tip" id="fullVideoTip" style="display: none;">å®Œæ•´è§†é¢‘åŠ è½½å®Œæˆï¼Œæ”¯æŒæ’­æ”¾/æš‚åœ/è¿›åº¦æ¡/éŸ³é‡æ§åˆ¶</p>
                     <div class="risk-chart-container">
                        <h4>æ—¶åºé£é™©æ³¢åŠ¨å›¾</h4>
                        <button id="analyzeTimelineFrameBtn" class="btn" style="margin-bottom: 15px; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);" disabled>
                          ğŸ“ è§£è¯»å½“å‰é€‰ä¸­å¸§
                        </button>
                        <div class="chart-scroll-wrapper">
                            <canvas id="riskTimelineChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                    <div class="risk-chart-container radar-container">
                        <h4>é£é™©ç±»åˆ«é›·è¾¾å›¾</h4>
                        <canvas id="riskCategoryChart" class="chart-canvas chart-canvas-radar"></canvas>
                   </div>

                    <div style="margin-top: 15px;">
                        <button id="retryFullVideoBtn" class="btn"
                            style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                            <span>é‡æ–°åŠ è½½è§†é¢‘</span>
                        </button>
                    </div>
              </div>
          </div>
        </div>

        <!-- 6. åŠ è½½æç¤º -->
        <div class="loading" id="loadingArea">
            <p>â³ æ­£åœ¨åˆå§‹åŒ–åˆ†æï¼Œè¯·ç¨å€™...</p>
            <div class="loading-spinner"></div>
        </div>

        <!-- 7. é”™è¯¯æç¤º -->
        <div class="error-area" id="errorArea">
            <div class="error-title">
                <span>âŒ é”™è¯¯</span>
            </div>
            <div id="errorContent" style="line-height: 1.6; padding: 10px 0;"></div>
            <div style="margin-top: 15px;">
                <button id="retryBtn" class="btn" style="background: #95a5a6;">è¿”å›é‡è¯•</button>
            </div>
        </div>
    </div>

    <script src="static/js/åˆå§‹åŒ–.js"></script>
    <script src="static/js/ä¸Šä¼ è§†é¢‘.js"></script>
    <script src="static/js/åˆ†æ.js"></script>
    <script src="static/js/æ£€æŸ¥.js"></script>

    <script>
        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å·¥å…·å‡½æ•°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 MB';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// è§†é¢‘æ—¶é•¿æ ¼å¼åŒ–å·¥å…·å‡½æ•° (æ”¯æŒ æ—¶:åˆ†:ç§’)
function formatVideoDuration(seconds) {
    if (isNaN(seconds) || seconds <= 0) return '00:00';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    return [h > 0 ? h : '', m, s].filter(v=>v!=='').map(v=>v.toString().padStart(2, '0')).join(':');
}

// 1. åˆ‡æ¢è§†é¢‘æ¥æºé€»è¾‘
function toggleVideoSource(radio) {
    const localFileArea = document.getElementById('localFileArea');
    const videoUrlArea = document.getElementById('videoUrlArea');
    const uploadBtn = document.getElementById('uploadBtn');
    const videoFileInput = document.getElementById('videoFileInput');
    const videoUrlInput = document.getElementById('videoUrlInput');

    if (radio.value === 'local') {
        localFileArea.style.display = 'block';
        videoUrlArea.style.display = 'none';
        uploadBtn.disabled = (videoFileInput.files.length === 0);
    } else {
        localFileArea.style.display = 'none';
        videoUrlArea.style.display = 'block';
        uploadBtn.disabled = (videoUrlInput.value.trim() === '');
    }
}

// ç›‘å¬æœ¬åœ°æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯+å¯ç”¨æŒ‰é’®
document.getElementById('videoFileInput').addEventListener('change', function() {
    const uploadBtn = document.getElementById('uploadBtn');
    const localPreviewInfo = document.getElementById('localPreviewInfo');
    const videoFileName = document.getElementById('videoFileName');
    const videoFileSize = document.getElementById('videoFileSize');

    if (this.files.length > 0) {
        const file = this.files[0];
        uploadBtn.disabled = false;
        localPreviewInfo.style.display = 'block';
        videoFileName.textContent = file.name;
        videoFileSize.textContent = formatFileSize(file.size);
    } else {
        uploadBtn.disabled = true;
        localPreviewInfo.style.display = 'none';
        videoFileName.textContent = 'æœªé€‰æ‹©';
        videoFileSize.textContent = '0 MB';
    }
});

// 2. ç›‘å¬URLè¾“å…¥
document.getElementById('videoUrlInput').addEventListener('input', function() {
    const uploadBtn = document.getElementById('uploadBtn');
    const isUrlSelected = document.querySelector('input[name="videoSource"][value="url"]').checked;

    if (isUrlSelected) {
        uploadBtn.disabled = (this.value.trim() === '');
    }
});

// 3. è¡¨å•æäº¤å‰å¢å¼ºéªŒè¯ï¼ˆä¿®å¤ç‰ˆï¼šæ°¸è¿œé˜»æ­¢åŸç”Ÿæäº¤ï¼‰
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    // â­ å…³é”®ä¿®å¤ï¼šæ— æ¡ä»¶é˜»æ­¢åŸç”Ÿ form æäº¤
    e.preventDefault();

    const selectedSource = document.querySelector('input[name="videoSource"]:checked').value;
    const videoFileInput = document.getElementById('videoFileInput');
    const videoUrlInput = document.getElementById('videoUrlInput');

    if (selectedSource === 'local' && videoFileInput.files.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼');
        return false;
    }

    if (selectedSource === 'url') {
        const url = videoUrlInput.value.trim();
        if (url === '') {
            alert('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„è§†é¢‘URLï¼');
            return false;
        }
        if (!/^https?:\/\//i.test(url)) {
            alert('è§†é¢‘URLæ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
            return false;
        }
    }

    return false;
});


// ========== ä¿®å¤ï¼šâ€œæˆ‘è¦åé¦ˆâ€çš„è§†é¢‘IDè·å–é€»è¾‘ ==========
function goToFeedbackForVideo() {
    // ä¼˜å…ˆä»â€œå¼€å§‹åˆ†æâ€æŒ‰é’®çš„data-vidè·å–ï¼ˆä¸Šä¼ åä¼šè®¾ç½®ï¼‰ï¼Œå†å–å…¨å±€å˜é‡
    const startBtn = document.getElementById('startAnalysisBtn');
    const videoId = startBtn.dataset?.vid || window.currentVideoId || null;

    if (!videoId) {
        alert("âš ï¸ è¯·å…ˆå®Œæˆè§†é¢‘ä¸Šä¼ å’Œåˆ†æï¼Œå†æäº¤åé¦ˆï¼");
        return;
    }

    let feedbackUrl = "feedback.html?video_id=" + encodeURIComponent(videoId);

    const feedbackWin = window.open(
        feedbackUrl,
        "videoFeedback",
        "width=1000,height=700,top=100,left=200,toolbar=no,menubar=no,scrollbars=yes,resizable=true"
    );

    // åé¦ˆé¡µå…³é—­ååˆ·æ–°äººå·¥å®¡æ ¸ç»“æœ
    const checkFeedbackClose = setInterval(() => {
        if (feedbackWin.closed) {
            clearInterval(checkFeedbackClose);
            loadReAuditResult(videoId);
        }
    }, 1000);
}

// 5. å¸§è§£è¯»æ°”æ³¡å…³é—­æŒ‰é’®äº‹ä»¶
document.getElementById('bubbleCloseBtn').addEventListener('click', function() {
    document.getElementById('frameDescBubble').style.display = 'none';
});

// 6. å®Œæ•´è§†é¢‘åŠ è½½å®Œæˆæç¤º
document.getElementById('fullVideoPlayer').addEventListener('loadedmetadata', function() {
    document.getElementById('fullVideoLoading').style.display = 'none';
    document.getElementById('fullVideoTip').style.display = 'block';
});

// ========== ä¿®å¤ï¼šäººå·¥å®¡æ ¸ç»“æœåŠ è½½ï¼ˆä¸åç«¯å­—æ®µåŒ¹é…ï¼‰ ==========
function loadReAuditResult(videoId) {
    if (!videoId) return;

    // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
    const reAuditLevelEl = document.getElementById('reAuditLevel');
    const reAuditDescEl = document.getElementById('reAuditDesc');
    const reAuditTimeEl = document.getElementById('reAuditTime');
    reAuditLevelEl.textContent = 'åŠ è½½ä¸­...';
    reAuditLevelEl.style.color = '#f39c12';
    reAuditDescEl.textContent = 'æ­£åœ¨è·å–æœ€æ–°å®¡æ ¸ç»“æœ...';
    reAuditTimeEl.textContent = 'â€”â€”';

    fetch(`/get-video-info?video_id=${encodeURIComponent(videoId)}`)
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                const videoInfo = result.video_info;
                const reAudit = videoInfo.re_audit_result || {};

                // æƒ…å†µ1ï¼šæœªå®¡æ ¸/å®¡æ ¸ä¸­
                if (reAudit.status !== 'completed') {
                    reAuditLevelEl.textContent = 'æš‚æ— ';
                    reAuditLevelEl.style.color = '#95a5a6';
                    reAuditDescEl.textContent = 'æš‚æ— äººå·¥å®¡æ ¸ï¼ˆå®¡æ ¸ä¸­/æœªå®¡æ ¸ï¼‰';
                    reAuditTimeEl.textContent = 'â€”â€”';
                    document.getElementById('reAuditNotice')?.remove();
                    return;
                }

                // æƒ…å†µ2ï¼šå®¡æ ¸å®Œæˆï¼Œæ¸²æŸ“ç»“æœ
                let levelColor = '#3498db'; // ä½é£é™©-è“è‰²
                if (reAudit.risk_level === 'é«˜') levelColor = '#e74c3c'; // é«˜é£é™©-çº¢è‰²
                if (reAudit.risk_level === 'ä¸­') levelColor = '#f39c12'; // ä¸­é£é™©-æ©™è‰²

                reAuditLevelEl.textContent = reAudit.risk_level || 'æœªçŸ¥';
                reAuditLevelEl.style.color = levelColor;
                reAuditDescEl.textContent = reAudit.desc || 'æ— å®¡æ ¸è¯´æ˜';
                reAuditTimeEl.textContent = reAudit.audit_time || 'æœªçŸ¥æ—¶é—´';

                // æ˜¾ç¤ºå®¡æ ¸å®Œæˆæç¤º
                if (!document.getElementById('reAuditNotice')) {
                    const notice = document.createElement('div');
                    notice.id = 'reAuditNotice';
                    notice.style.cssText = `
                        color: #27ae60;
                        font-weight: bold;
                        font-size: 14px;
                        margin-top: 10px;
                        padding: 8px;
                        background: rgba(39, 174, 96, 0.1);
                        border-radius: 4px;
                        text-align: center;
                    `;
                    notice.innerHTML = 'âœ… äººå·¥å®¡æ ¸å·²å®Œæˆï¼ç»“æœå·²æ›´æ–°';
                    reAuditDescEl.parentNode.appendChild(notice);
                }
            } else {
                reAuditLevelEl.textContent = 'æš‚æ— ';
                reAuditLevelEl.style.color = '#95a5a6';
                reAuditDescEl.textContent = 'è·å–å®¡æ ¸ç»“æœå¤±è´¥ï¼Œè¯·ç‚¹å‡»åˆ·æ–°';
                reAuditTimeEl.textContent = 'â€”â€”';
            }
        })
        .catch(err => {
            console.error('æ‹‰å–äººå·¥å®¡æ ¸ç»“æœå¤±è´¥ï¼š', err);
            reAuditLevelEl.textContent = 'æš‚æ— ';
            reAuditLevelEl.style.color = '#95a5a6';
            reAuditDescEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢';
            reAuditTimeEl.textContent = 'â€”â€”';
        });
}

// è½®è¯¢æ£€æŸ¥äººå·¥å®¡æ ¸ç»“æœï¼ˆæ¯10ç§’ä¸€æ¬¡ï¼‰
let reAuditPollingTimer;
function startReAuditPolling(videoId) {
    if (!videoId || reAuditPollingTimer) return;
    loadReAuditResult(videoId);
    reAuditPollingTimer = setInterval(() => {
        loadReAuditResult(videoId);
    }, 10000);
}

// åœæ­¢è½®è¯¢
window.addEventListener('beforeunload', () => {
    if (reAuditPollingTimer) clearInterval(reAuditPollingTimer);
});

// ========== é¡µé¢åˆå§‹åŒ– + è§†é¢‘IDèµ‹å€¼ ==========
window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('video_id');

    // å®¡æ ¸ç«¯ä¼ å…¥è§†é¢‘IDçš„æƒ…å†µ
    if (videoId) {
        console.log('æ£€æµ‹åˆ°å®¡æ ¸ç«¯è§†é¢‘IDï¼Œè‡ªåŠ¨åŠ è½½ï¼š', videoId);
        document.getElementById('uploadForm').style.display = 'none';
        document.getElementById('videoPreviewArea').style.display = 'block';

        fetch(`/get-video-info?video_id=${videoId}`)
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    const videoInfo = result.video_info;
                    window.currentVideoId = videoId; // èµ‹å€¼å…¨å±€è§†é¢‘ID
                    const startBtn = document.getElementById('startAnalysisBtn');
                    startBtn.dataset.vid = videoId; // è®¾ç½®æŒ‰é’®çš„data-vid
                    startBtn.disabled = false;

                    const previewPlayer = document.getElementById('previewVideoPlayer');
                    previewPlayer.src = videoInfo.url;

                    document.getElementById('videoFileName').textContent = videoInfo.original_name;
                    document.getElementById('videoFileSize').textContent = formatFileSize(videoInfo.size || 0);

                    previewPlayer.onloadedmetadata = function() {
                        document.getElementById('videoDuration').textContent = formatVideoDuration(this.duration);
                        document.getElementById('videoDimensions').textContent = `${this.videoWidth}Ã—${this.videoHeight}`;
                    };

                    previewPlayer.onerror = function() {
                        alert("è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘åœ°å€æ˜¯å¦æœ‰æ•ˆï¼");
                    };

                    document.querySelector('.video-tip').textContent = 'âœ… è§†é¢‘å·²ä»å®¡æ ¸ç«¯è¯·æ±‚åŠ è½½å®Œæˆ';
                    startReAuditPolling(videoId);
                } else {
                    alert('åŠ è½½è§†é¢‘å¤±è´¥ï¼š' + result.message);
                    document.getElementById('uploadForm').style.display = 'block';
                    document.getElementById('videoPreviewArea').style.display = 'none';
                }
            })
            .catch(err => {
                alert('ç½‘ç»œé”™è¯¯ï¼šæ— æ³•åŠ è½½è§†é¢‘ - ' + err.message);
                document.getElementById('uploadForm').style.display = 'block';
                document.getElementById('videoPreviewArea').style.display = 'none';
            });
    }

    // ç»‘å®šåˆ·æ–°äººå·¥å®¡æ ¸æŒ‰é’®
    if (document.getElementById('refreshReAuditBtn')) {
        document.getElementById('refreshReAuditBtn').addEventListener('click', function() {
            const vid = document.getElementById('startAnalysisBtn').dataset?.vid || window.currentVideoId;
            if (vid) {
                loadReAuditResult(vid);
                alert('å·²æ‰‹åŠ¨åˆ·æ–°äººå·¥å®¡æ ¸ç»“æœï¼');
            } else {
                alert('æš‚æ— è§†é¢‘IDï¼Œè¯·å…ˆå®Œæˆè§†é¢‘åˆ†æï¼');
            }
        });
    }
});

    </script>

</body>
</html>